generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id        String    @id @default(cuid())
  email     String    @unique
  password  String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  accounts  Account[]
}

model Account {
  id             String         @id @default(cuid())
  userId         String
  name           String
  type           String
  currency       String         @default("USD")
  initialBalance Float
  currentBalance Float          @default(0)
  equity         Float          @default(0)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  gridStrategies GridStrategy[]
  spotHoldings   SpotHolding[]
  trades         Trade[]
}

model Trade {
  id                String         @id @default(cuid())
  accountId         String
  type              String
  segment           String?
  symbol            String
  side              String
  marginMode        String?
  tradeType         String?
  session           String?
  analysisTimeframe String?
  entryTimeframe    String?
  entryPrice        Float
  entryDate         DateTime       @default(now())
  entryCondition    String?
  stopLoss          Float?
  takeProfit        Float?
  quantity          Float
  leverage          Float?
  marginUsed        Float?
  exitPrice         Float?
  exitDate          DateTime?
  exitQuantity      Float?
  exitCondition     String?
  status            String         @default("OPEN")
  netPnL            Float?
  netPnLPercent     Float?
  rMultiple         Float?
  liquidationPrice  Float?
  maintenanceMargin Float?
  fundingFees       Float?         @default(0)
  remarks           String?
  setup             String?
  thesis            String?
  executionNotes    String?
  postTradeReview   String?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  parentId          String?
  images            Image[]
  journalEntries    JournalEntry[]
  account           Account        @relation(fields: [accountId], references: [id], onDelete: Cascade)
  parent            Trade?         @relation("PartialExits", fields: [parentId], references: [id])
  children          Trade[]        @relation("PartialExits")
}

model TradeCondition {
  id        String   @id @default(cuid())
  name      String
  type      String
  createdAt DateTime @default(now())

  @@unique([name, type])
}

model GridStrategy {
  id                      String         @id @default(cuid())
  accountId               String
  type                    String
  symbol                  String
  lowerPrice              Float
  upperPrice              Float
  gridCount               Int
  allocatedCapital        Float
  direction               String         @default("NEUTRAL")
  leverage                Float?
  marginMode              String?
  maintenanceMarginRate   Float?
  liquidationPrice        Float?
  status                  String         @default("ACTIVE")
  realizedPnL             Float          @default(0)
  fees                    Float          @default(0)
  createdAt               DateTime       @default(now())
  updatedAt               DateTime       @updatedAt
  closeNote               String?
  entryPrice              Float?
  exitPrice               Float?
  gridProfit              Float?
  investmentAfterLeverage Float?
  maintenanceMargin       Float?
  totalProfit             Float?
  orders                  GridOrder[]
  account                 Account        @relation(fields: [accountId], references: [id], onDelete: Cascade)
  journalEntries          JournalEntry[]
}

model GridOrder {
  id       String       @id @default(cuid())
  gridId   String
  price    Float
  quantity Float
  side     String
  status   String
  filledAt DateTime?
  grid     GridStrategy @relation(fields: [gridId], references: [id], onDelete: Cascade)
}

model SpotHolding {
  id            String   @id @default(cuid())
  accountId     String
  assetSymbol   String
  quantity      Float
  avgEntryPrice Float
  targetPrice   Float?
  exitPrice     Float?
  status        String   @default("HODLING")
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  account       Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
}

model JournalEntry {
  id         String        @id @default(cuid())
  tradeId    String?
  gridId     String?
  date       DateTime      @default(now())
  title      String?
  content    String
  confidence Int?
  fear       Int?
  fomo       Int?
  discipline Int?
  tags       String?
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  grid       GridStrategy? @relation(fields: [gridId], references: [id])
  trade      Trade?        @relation(fields: [tradeId], references: [id])
}

model Image {
  id        String   @id @default(cuid())
  url       String
  tradeId   String?
  createdAt DateTime @default(now())
  trade     Trade?   @relation(fields: [tradeId], references: [id], onDelete: Cascade)
}
